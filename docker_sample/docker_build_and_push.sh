# エラーが発生した時点でシェルスクリプトを終了させるためのコマンド
set -e

# docker image名の指定
image=drawing-type-classification

profile=aoz
# aws accountの取得
account=$(aws sts get-caller-identity --query Account --output text --profile ${profile})
# aws configure list に記載しているregionの取得
region=$(aws configure get region --profile ${profile})

# ecr repositoryの指定
repo_uri="${account}.dkr.ecr.${region}.amazonaws.com"
# imageのtagの指定
fullname="${repo_uri}/${image}:latest"
# git連携するためのdeploy keyの指定(Dockerfileで使う)
DEPLOY_KEY=LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFy
WlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUNGd0FB
QUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFnRUF2dGJHSEM2Y01vdHVXeEpzaTV1
TGhsdEtSSnRuVWdNVFh1SXkrcDAxdForbG5IL0hFNEJ3CmsveHFtK01zUSs5dHpS
K1paSFh1MDBUU2h0OUpieW52Qk5Od3JzK2FiYm1aSk9pZFNKOU9ZMURnMmlPY200
eWZvM3FhQ3EKSXBvajRQM0FiMHo4ME0wc2hXV3BKbTNJYlErZTlpTFpibUNUN0ZZ
SDNyNjBuVDdqRjlOb1QvY2dkQ3JLZXR0ZVlPSFFnNApWMk5yZHFZK2piTlI5cU1i
cXY4MkdSRjdRKzcrME9TdGZ6L3p5MWczTnJ2UFRBRGl4dFdtZ3Z0djNLd1AwU3Fs
c01HdHVZCldyeS9OOVdaR3NId2Y5UkFwNGdoZ0RVcnVOeHhWeU5kRWtwOGVpQTIw
RStmMGhhN0JPbFdWcjdLYTNaQ0JYYmgvbEx2VW4KNklXT2NsNlU5QzRYcVNLRjJt
RHptZ096d3ZOTmJtUms5bmVtTWxsTnBiRXpLMTh3d1RYZUhGVCtjbHRXSHdhVWdx
dW1RcApqUjdPekcxbU9BNVlzMS9SeG40RXdqYnBhWHBEaExDUWF2TUZpMjZsM3JG
S2lRUEt1akM4MEU1ajhEanpBTFR6SEJaa0hiClVzdVg3b00wTDArRGpPT1NXRThT
TlpUMHJwT2t2V2l0dUc1UFFsNnRCSUc2YzdodXk5d1ZiMERabDBkc01yWkowTDVj
TUoKeVFIaHFjalJsdXVHV3IxOUkydHBuNDJKQVFkUzBKK2V1ZFl6ZDNVT1pkWUZU
NWt6aS8vREpjditpYTB4dDV1Znp2NStKKwpzNldwdkZDaGtFN0xFUEtIZ3VWZ1lo
TFRNQUFNbHVRUGxmZWc0czk2SDNOSU5QeWk0OVV4NXQ1SVRiQytDQmY2RWlQajJP
CjhBQUFkUURaS09FZzJTamhJQUFBQUhjM05vTFhKellRQUFBZ0VBdnRiR0hDNmNN
b3R1V3hKc2k1dUxobHRLUkp0blVnTVQKWHVJeStwMDF0WitsbkgvSEU0QndrL3hx
bStNc1ErOXR6UitaWkhYdTAwVFNodDlKYnludkJOTndycythYmJtWkpPaWRTSgo5
T1kxRGcyaU9jbTR5Zm8zcWFDcUlwb2o0UDNBYjB6ODBNMHNoV1dwSm0zSWJRK2U5
aUxaYm1DVDdGWUgzcjYwblQ3akY5Ck5vVC9jZ2RDcktldHRlWU9IUWc0VjJOcmRx
WStqYk5SOXFNYnF2ODJHUkY3USs3KzBPU3Rmei96eTFnM05ydlBUQURpeHQKV21n
dnR2M0t3UDBTcWxzTUd0dVlXcnkvTjlXWkdzSHdmOVJBcDRnaGdEVXJ1Tnh4VnlO
ZEVrcDhlaUEyMEUrZjBoYTdCTwpsV1ZyN0thM1pDQlhiaC9sTHZVbjZJV09jbDZV
OUM0WHFTS0YybUR6bWdPend2Tk5ibVJrOW5lbU1sbE5wYkV6SzE4d3dUClhlSEZU
K2NsdFdId2FVZ3F1bVFwalI3T3pHMW1PQTVZczEvUnhuNEV3amJwYVhwRGhMQ1Fh
dk1GaTI2bDNyRktpUVBLdWoKQzgwRTVqOERqekFMVHpIQlprSGJVc3VYN29NMEww
K0RqT09TV0U4U05aVDBycE9rdldpdHVHNVBRbDZ0QklHNmM3aHV5OQp3VmIwRFps
MGRzTXJaSjBMNWNNSnlRSGhxY2pSbHV1R1dyMTlJMnRwbjQySkFRZFMwSitldWRZ
emQzVU9aZFlGVDVremkvCi9ESmN2K2lhMHh0NXVmenY1K0orczZXcHZGQ2hrRTdM
RVBLSGd1VmdZaExUTUFBTWx1UVBsZmVnNHM5NkgzTklOUHlpNDkKVXg1dDVJVGJD
K0NCZjZFaVBqMk84QUFBQURBUUFCQUFBQ0FRQ1ZZUUp6bnR4dkNBc2F5SUlraVYy
ZWpxakVxU3duMnZaMwpwL0dsa0JjeGtzU01pc3htYkh3eXFqczh5SWFtcXF5MUNr
NEVmL2V3Y2NlbEFQUzNTZ2lwSzJTaHdTa3RTRUVpemQ0SHNZCk1uWkhDTTc2RXZk
TlNrbjF3aWhLcTRMNEkwaFZGdHN5Q2RnV2x1dmZnOEdGOU50RjZTTnZMYk84STk5
SE1ObXAyRWJrS0gKd1hVK2FZWjhKVWhwQUtuOWVhaTRacjhBZ2NLbklqMC9KSStN
dXZZNml4K0VubmZoUlk2MDgzYytyVStTelZISE9VNUp1NApUNk5CeHNqRlpaTU51
L1R1dFFNOXkwNldRdUQwTytpbjlwbWhTWUtIbTVjY3Zaa09UMFVVQXpBS1hGcnJs
ZGdSRisvT09XCk4yeFNNbkdNczNBY2FHVDU2N1lRWVRLT1BaQ3pjdFc4N3F3c1BE
WmkrMGJaQlpLOEtzK3pxWUk5RjRCZ1VMWlZQYi8ybVcKU05WSzliRStpQVdkSzNw
Z05ZVWRwM3FMSlZ3VHFHNTA1OGRTZ1JYSFhBa29ZQVh6Y2Y0VlNlZDY5L3RhTjRy
MTdVQVQxbQpaMS9UQUcrd3M2YWlOOWtySHhqcU5jOWhIeXNDQ1V3MzBlRFk5Qnlh
Sk5iNlJ4MUxpSnYra3U4akVXMlprZnkxYjdjMVZ4CmovMndvVEZGTzhXVjNZWUFs
TnJXU04wT0J2SzhPV2ZONUxrT2M0dlo1NFVOM3B5M0Z5SGxqcXpSUXA0ckxBYVpw
MDhhVXMKclNMMzFDdkEzbjR3QkhyR09PZFZpcHVFS0h5bG93cEF4dFl6RXdhOWJu
cVIzZjlHUmFiK3UwaW1YY1krS0dkMEtQY040Rgp6YklPT0t6MmdUeDZmRVIxN1Zp
UUFBQVFFQWtGT0VvUFlTNXBscklEVVlzRkswZ1FnYmVFZ0YwTm90SXptOVR4WUJ1
dFA5CkFrYWZ2V01iY3EzdFpZVStFVjgvMGtITTBlQ21FMXkzeGtaSG5TVTFyRndD
eFF2d0luMUJrLzZhbGc5aXBNZldodmozQloKdTlVSlNtWE1LMHd0dzRYS0ZZOFVR
TExRQ3RhUVlkbldDdlkzb0tjaXFIZnd4bml6eU1QeFRkbE95NUdtdFVYUmFHQ3p4
MQpSVG9wMWJrMk1VUnp1dUJHQ1M3TE5oN0UxY3VNNkRZVHEvaFJ6dUtBc0xNK1B6
a0RLWDhoNzQ5MG0zWnlBQ1pSeHlFTWthCkpXOXpmTHh4SHNoMWdDUXY2dmE0dVdt
UUZLaTZJeXB4SFp1QU9ScFU3MHRGTlFvN09KeU1WTWJZNHczYmhqZ09HTGNTUlMK
UDlCTytaOWQyTVlwODZoMzBRQUFBUUVBN1U2K3hpWmp6bUE5MDF2R1FNSTBwYldU
WFdpaW1ITCtvcXc5ZVZRcnlVb2FkWApsSDZkNzVhTXYzQkpLdllqaVFlUHgxZVVI
eVFybnhwM252NG0ySnAwaXV0dnp4SlNoM2tZRXFITFkrZ3paNGt5b1ZoREtJCk9R
R2d2SUdBNTBZTHc5SC9LVFhEbS9UOTFaa1dhNHI0NUlYeFhRZmJHdDJoZHBJakJp
SG9kTTZCRTljZC91ejJjSkY4R0gKdTdISzdpL1ZMbnVHSllDRGY0STI4NzNKemxL
aEpMK0ZEMXpFQndIQ1VJdFBTZHZyOGJGQXRmc3dzNFJ1RUpTYWJPVWs2YQorbS9z
OGxxZmRsWE01WTByT1A3NzBvb09tNTAxWG5qM0QzQWZHQWhubU5yUGduSTJ5UFgz
eW5yTE91L1NPY3g3cC9VbW84ClJmODRISFNiSFkwcENrWFFBQUFRRUF6ZDcvdWpz
YjRzLzNpa2FSdkxYZFNuaHc1UkJVdTlkcUxJei9idjdYT0ZwM0I4aXQKSzB4V29v
czR3NmE0Qi9YVytzVUMvbXBkbjVSR0tqOEk0MUhmWFR1bTRFVFp4aFk1cnJGS1J2
TUt4NmpFTUtpaHRFSUR0Mwo3eTgyOHdIVWhGdkhOWVhJNDN2dWpCSHpoUHlINndG
eVY2bkc5bDQySSs5cWdFSTJCcTMzaVF4b2U5WnV4eWZxYlh0S0F6CmZ2OWNQaWZ1
aHo0Y1JteUF2aXZHYTRWQnhaUStqME5KLzhYRE5LVlV0OTBwTWVOdVhBY0I3Y2Iz
RFpQWHQ5TWJxenFyR0cKREhtVGJuc05UVUQ5TCtwck1TYnlCeG1QMkZxTFpGdWFK
Wm1ZNGRDQmo5akFRemVHMlpMajZjcVdzbTFIS0pMUUpUajFwYgpCZXpsU2dGU1Fq
NWR1d0FBQUJSNWEyVnVhMjkxTURBeFFHZHRZV2xzTG1OdmJRRUNBd1FGCi0tLS0t
RU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo=

# DEPLOY_KEY=dummy

# ecr login
aws ecr get-login-password \
    --region ${region} \
    --profile ${profile} | \
    docker login \
           --username AWS \
           --password-stdin https://${repo_uri}
# docker build
docker build -t ${image} --build-arg DEPLOY_KEY=${DEPLOY_KEY} ./api
# imageにtag付与
docker tag ${image}:latest ${fullname}
# imageをecrにpush
docker push ${fullname}